#!/usr/bin/env bash

rofi_command="rofi -theme $HOME/.config/rofi/config/network.rasi"

# Fast wifi status
STATUS="$(nmcli -t -f WIFI g)"
SSID="$(nmcli -t -f ACTIVE,SSID dev wifi | awk -F: '$1=="yes"{print $2}')"

# Fast connectivity check (nmcli built-in)
if nmcli -t -f CONNECTIVITY g | grep -q full; then
    connected="Online"
    active="-a 0"
    urgent=""
else
    connected="Offline"
    active=""
    urgent="-u 0"
    SSID="Disconnected"
fi

# Options
launch_cli="Open Network Manager (nmtui)"
launch="Open Connection Editor"

options="$connected\n$launch_cli\n$launch"

# Show rofi immediately
chosen="$(printf "%b" "$options" | \
    $rofi_command -p "$SSID" -dmenu $active $urgent -selected-row 1)"

case $chosen in
    "$connected")
        if [[ "$STATUS" == "enabled" ]]; then
            nmcli radio wifi off
        else
            nmcli radio wifi on
        fi
        ;;
    "$launch_cli")
        kitty -e nmtui
        ;;
    "$launch")
        nm-connection-editor
        ;;
esac
