#!/usr/bin/env bash

# Wallpaper selector with predefined colors and automatic time-based selection
rofi_command="rofi -no-fixed-num-lines -show-icons -markup-rows -theme $HOME/.config/rofi/config/wallpaper-grid.rasi"

# Wallpaper directory
WALLPAPER_DIR="$HOME/.config/polybar/Wallpaper"
COLORS_FILE="$HOME/.config/rofi/config/colors.rasi"
TEMP_SELECTION_FILE="/tmp/wallpaper_selection"

# Function for automatic wallpaper based on time
auto_wallpaper() {
    if [[ -f "$TEMP_SELECTION_FILE" ]]; then
        manual_selection=$(cat "$TEMP_SELECTION_FILE")
        wallpaper_path="$WALLPAPER_DIR/$manual_selection"

        if [[ -f "$wallpaper_path" ]]; then
            wallpaper_name="$manual_selection"
            set_wallpaper "$wallpaper_path"
            set_wallpaper_colors "$wallpaper_name"
            return 0
        else
            rm -f "$TEMP_SELECTION_FILE"
        fi
    fi

    current_hour=$(date +%H)
    current_hour=$((10#$current_hour))

    if [[ $current_hour -ge 6 && $current_hour -lt 18 ]]; then
        wallpaper_path="$WALLPAPER_DIR/white.png"
        wallpaper_name="white.png"
    else
        wallpaper_path="$WALLPAPER_DIR/dark.png"
        wallpaper_name="dark.png"
    fi

    if [[ -f "$wallpaper_path" ]]; then
        set_wallpaper "$wallpaper_path"
        set_wallpaper_colors "$wallpaper_name"
        return 0
    else
        notify-send "Error" "Auto wallpaper file not found: $wallpaper_path" -t 5000
        return 1
    fi
}

# Function to set colors for a specific wallpaper
set_wallpaper_colors() {
    local wallpaper_name="$1"

    case "$wallpaper_name" in
        "black.jpg")
            cat > "$COLORS_FILE" << 'EOF'
/* black Theme */
* {
    BG:    #252525;        /* background color */
    BGA:   #606060;        /* the selector color */
    FG:    #ffffff;        /* unselected text color */
    SEL:   #ffffff;        /* selected text color */
    BDR:   #c4c1c1;        /* search border color */
    BG-A:  #c4c1c1;        /* element border color */
    OFF:   #666666;        /* off color */
    ON:    #00ff00;        /* on color */
    FGA:   #FC1100;        /* focused text accent */
    IMG:   #4da6ff;        /* image/icon color */
    UGT:   #e67e22;        /* urgent color */
}
EOF
            ;;
        "cherry.jpg")
            cat > "$COLORS_FILE" << 'EOF'
/* cherry Theme */
* {
    BG:    #252525;        /* background color */
    BGA:   #E1B2BB;        /* the selector color */
    FG:    #ffffff;        /* unselected text color */
    SEL:   #ffffff;        /* selected text color */
    BDR:   #D9A8B0;        /* search border color */
    BG-A:  #D9A8B0;        /* element border color */
    OFF:   #666666;     /* off color */
    ON:    #00ff00;        /* on color */
    FGA:   #FC1100;        /* focused text accent */
    IMG:   #4da6ff;        /* image/icon color */
    UGT:   #e67e22;        /* urgent color */
}
EOF
            ;;
        "studio-ghibli.png")
            cat > "$COLORS_FILE" << 'EOF'
/* Studio Ghibli Theme */
* {
    BG:    #252525;        /* background color */
    BGA:   #63b4e3;        /* the selector color */
    FG:    #ffffff;        /* unselected text color */
    SEL:   #ffffff;        /* selected text color */
    BDR:   #c4c1c1;        /* search border color */
    BG-A:  #313244;        /* element border color */
    OFF:   #666666;     /* off color */
    ON:    #00ff00;        /* on color */
    FGA:   #FC1100;        /* focused text accent */
    IMG:   #4da6ff;        /* image/icon color */
    UGT:   #e67e22;        /* urgent color */
}
EOF
            ;;
        "fuji.png")
            cat > "$COLORS_FILE" << 'EOF'
/* Mountain Theme - Auto-extracted colors */
* {
    BG:    #0c0c1c;        /* background color */
    BGA:   #3C5483;        /* the selector color */
    FG:    #ffffff;        /* unselected text color */
    SEL:   #ffffff;     /* selected text color */
    BDR:   #B48173;      /* search border color */
    BG-A:  #B48173;        /* element border color */
    OFF:   #666666;     /* off color */
    ON:    #00ff00;     /* on color */
    FGA:   #ffffff;        /* focused text accent */
    IMG:   #DC907D;     /* image/icon color */
    UGT:   #e67e22;     /* urgent color */
}
EOF
            ;;
        "nsfw.jpg")
            cat > "$COLORS_FILE" << 'EOF'
/* NSFW Theme */
* {
    BG:    #1c1c1ccc;     /* background color */
    BGA:   #dc143cff;     /* the selector color */
    FG:    #ffffffff;     /* unselected text color */
    SEL:   #1c1c1cff;     /* selected text color */
    BDR:   #dc143cff;     /* search border color */
    BG-A:  #313244;        /* element border color */
    OFF:   #666666ff;     /* off color */
    ON:    #00ff00ff;     /* on color */
    FGA:   #ffffffcc;     /* focused text accent */
    IMG:   #dc143cff;     /* image/icon color */
    UGT:   #ff4500ff;     /* urgent color */
}
EOF
            ;;
        "white.png")
            cat > "$COLORS_FILE" << 'EOF'
/* White Theme */
* {
    BG:    #ffdab9cc;     /* background color */
    BGA:   #333333ff;     /* the selector color */
    FG:    #000000ff;     /* unselected text color */
    SEL:   #e0e0e0ff;     /* selected text color */
    BDR:   #333333ff;     /* search border color */
    BG-A:  #313244;        /* element border color */
    OFF:   #ccccccff;     /* off color */
    ON:    #00ff00ff;     /* on color */
    FGA:   #333333ff;     /* focused text accent */
    IMG:   #333333ff;     /* image/icon color */
    UGT:   #ff6b6bff;     /* urgent color */
}
EOF
            ;;
        "dark.png")
            cat > "$COLORS_FILE" << 'EOF'
/* Dark Theme */
* {
    BG:    #2a2a2aff;     /* background color */
    BGA:   #FFDBCCFF;     /* the selector color */
    FG:    #ffffffff;     /* unselected text color */
    SEL:   #000000ff;     /* selected text color */
    BDR:   #FDE0D9ff;     /* search border color */
    BG-A:  #FDE0D9CC;     /* element border color */
    OFF:   #666666ff;     /* off color */
    ON:    #00ff00ff;     /* on color */
    FGA:   #000000ff;     /* focused text accent */
    IMG:   #FDE0D9ff;     /* image/icon color */
    UGT:   #ef4444ff;     /* urgent color */
}
EOF
            ;;
        *)
            cat > "$COLORS_FILE" << 'EOF'
/* Default Theme */
* {
    BG:    #212232;        /* background color */
    BGA:   #63b4e3;        /* the selector color */
    FG:    #FFFFFF;        /* unselected text color */
    SEL:   #FFFFFF;        /* selected text color */
    BDR:   #CBA6F7;        /* search border color */
    BG-A:  #313244;        /* element border color */
    OFF:   #575268;        /* off color */
    ON:    #ABE9B3;        /* on color */
    FGA:   #FFFFFF;        /* focused text accent */
    IMG:   #FAE3B0;        /* image/icon color */
    UGT:   #F28FAD;        /* urgent color */
}
EOF
            ;;
    esac
}

# Function to set wallpaper
set_wallpaper() {
    local wallpaper_path="$1"
    feh --bg-fill "$wallpaper_path" 2>/dev/null
}

# Auto mode
if [[ "$1" == "--auto" || "$1" == "-a" ]]; then
    auto_wallpaper
    exit 0
fi

# Ensure wallpaper directory exists
if [[ ! -d "$WALLPAPER_DIR" ]]; then
    echo "Wallpaper directory not found!" | $rofi_command -p "Error" -dmenu -no-custom -selected-row 0
    exit 1
fi

# Generate menu entries with image previews
menu_options="󰄯  Auto (Time-based)\0icon\x1fclock\n"
declare -A wallpaper_map
wallpaper_map["󰄯  Auto (Time-based)"]="AUTO"

while IFS= read -r wallpaper; do
    filename=$(basename "$wallpaper")
    display_name="${filename%.*}"
    menu_options+="${display_name}\0icon\x1f${wallpaper}\n"
    wallpaper_map["$display_name"]="$wallpaper"
done <<< "$(find "$WALLPAPER_DIR" -type f \( -iname '*.jpg' -o -iname '*.png' -o -iname '*.jpeg' \) | sort)"

# Show Rofi menu with previews
chosen=$(echo -en "$menu_options" | rofi -dmenu -show-icons -markup-rows -p "Select Wallpaper" -theme "$HOME/.config/rofi/config/wallpaper-grid.rasi" -no-custom)

if [[ -n "$chosen" ]]; then
    if [[ "${wallpaper_map[$chosen]}" == "AUTO" ]]; then
        rm -f "$TEMP_SELECTION_FILE"
        auto_wallpaper
        exit 0
    fi

    wallpaper_path="${wallpaper_map[$chosen]}"
    if [[ -f "$wallpaper_path" ]]; then
        echo "$(basename "$wallpaper_path")" > "$TEMP_SELECTION_FILE"
        set_wallpaper "$wallpaper_path"
        original_filename=$(basename "$wallpaper_path")
        set_wallpaper_colors "$original_filename"
        notify-send "Wallpaper" "Applied: $chosen" -t 800
    else
        echo "Wallpaper file not found!" | $rofi_command -p "Error" -dmenu -no-custom -selected-row 0
    fi
fi
